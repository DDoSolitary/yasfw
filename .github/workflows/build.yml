on: push
jobs:
  build:
    strategy:
      matrix:
        rust_triplet: [x86_64-pc-windows-msvc, i686-pc-windows-msvc]
        include:
          - rust_triplet: x86_64-pc-windows-msvc
            vcpkg_triplet: x64-windows-static
            arch: x86_64
            abi: msvc
          - rust_triplet: i686-pc-windows-msvc
            vcpkg_triplet: x86-windows-static
            arch: i686
            abi: msvc
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@master
      - env:
          VCPKG_DEFAULT_TRIPLET: ${{ matrix.vcpkg_triplet }}
          RUSTFLAGS: -Ctarget-feature=+crt-static
        run: |
          pushd $Env:VCPKG_INSTALLATION_ROOT
          cmd /c "git pull 2>&1"
          .\bootstrap-vcpkg.bat
          popd
          vcpkg integrate install
          vcpkg install mbedtls[pthreads] zlib

          cmd /c "rustup toolchain install stable-${{ matrix.rust_triplet }} 2>&1"
          cmd /c "git fetch --tags --unshallow 2>&1"
          cmd /c "git submodule update --init 2>&1"
          $Env:DOKAN_DLL_OUTPUT_PATH = $PWD
          $Env:VCPKG_ROOT = $Env:VCPKG_INSTALLATION_ROOT
          cmd /c "cargo +stable-${{ matrix.rust_triplet }} build --release --target ${{ matrix.rust_triplet }} 2>&1"
          if ($LASTEXITCODE -ne 0) { exit 1 }

          7z a release.zip `
              .\LICENSE `
              .\dokan1.dll `
              .\target\${{ matrix.rust_triplet }}\release\yasfw.exe `
      - if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -Force ~\.ssh
          [IO.File]::WriteAllBytes( `
              "$Env:USERPROFILE\.ssh\id_ed25519", `
              [Convert]::FromBase64String("${{ secrets.DEPLOYKEY }}"))
          cmd /c 'ssh-keyscan web.sourceforge.net > "%USERPROFILE%\.ssh\known_hosts" 2>nul'
          cmd /c "scp release.zip ddosolitary@web.sourceforge.net:/home/project-web/ddosolitary-builds/htdocs/yasfw/yasfw-$(git describe --tags)-${{ matrix.arch }}-${{ matrix.abi }}.zip 2>&1"
          if ($LASTEXITCODE -ne 0) { exit 1 }
